{% extends "netadmin/base.html" %}
{% load staticfiles %}

{% block title %}
    Task Run Sets
{% endblock title %}

{% block content %}
    {% verbatim %}
    <div ng-controller="RunsetsContoller">
        <div id="task_filter">
            <md-input-container>
                <label>Task</label>
                <md-select ng-model="params.task" id="task-filter" style="width:200px">
                    <md-option value="">All tasks</md-option>
                    <md-option ng-repeat="task in tasks" value="{{ task.id }}">{{ task.name }}</md-option>
                </md-select>
            </md-input-container>
            <md-input-container>
                <label>Owner</label>
                <md-select ng-model="params.owner_id" id="owner-filter">
                    <md-option value="">All owners</md-option>
                    <md-option ng-repeat="owner in owners" value="{{ owner.id }}">{{ owner.name }}</md-option>
                </md-select>
            </md-input-container>
        </div>
        <div id="taskrunsets">
            <table class="table table-striped">
                <tr>
                    <th> task</th>
                    <th> owner</th>
                    <th> created at</th>
                </tr>
                <tr ng-repeat="result in results">
                    <td>{{ result.task_data.name }}</td>
                    <td>{{ result.owner_data }}</td>
                    <td>{{ result.created_at | date:'M/d/y, HH:mm:ss' }}</td>
                </tr>
            </table>

            <br>
            <div layout="row">
                <md-button ng-disabled="!pagination.previous_url"
                           class="md-icon-button md-raised"
                           ng-click="prevPage()"
                           aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </md-button>
                <md-button ng-repeat="page in pagination.page_links"
                           ng-disabled="page[3]"
                           class="md-icon-button"
                           ng-class="{'md-accent md-raised':page[2]==true}"
                           ng-click="setPage(page[1])">
                    <span ng-if="page[3]" aria-hidden="true">&hellip;</span>
                    <span ng-if="!page[3]">{{ page[1] }}</span>
                </md-button>
                <md-button ng-disabled="!pagination.next_url"
                           class="md-icon-button md-raised"
                           ng-click="nextPage()"
                           aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </md-button>
            </div>
        </div>
    </div>
    {% endverbatim %}

{% endblock content %}

{% block script %}

    {{ block.super }}
    <script>
        app.controller('RunsetsContoller', function RunSetController($scope, $http, $location) {
            $scope.params = {
                task: '',
                owner_id: '',
                page: 1
            };
            $http.get('{% url 'task_admin:api:task-list' %}', {params: {format: 'json'}}).then(function (response) {
                $scope.tasks = response.data;
            });
            $scope.setPage = function (n) {
                $scope.params.page = n;
            };
            function updatePage() {
                $http.get('{% url 'task_admin:api:taskrunset-list' %}',
                        {
                            params: $scope.params
                        }
                ).then(function (response) {
                    $scope.pagination = response.data.pagination;
                    $scope.results = response.data.results;
                    $location.search($scope.params);
                });
            }

            $scope.$watch("params.task", function (newValue, oldValue) {
                if (newValue == oldValue)return;
                $scope.params.page = 1;
                updatePage();
            });
            $scope.$watch("params.page", function (newValue, oldValue) {
                if (newValue == oldValue)return;
                updatePage();
            });
            $scope.prevPage = function () {
                $scope.params.page = parseInt($scope.params.page) - 1;
            };
            $scope.nextPage = function () {
                $scope.params.page = parseInt($scope.params.page) + 1;
            };

            $scope.owners = [
                {
                    id: '1',
                    name: 'admin'
                }
            ];
            $scope.params = jQuery.extend($scope.params, $location.search());
            updatePage();
        });
    </script>
{% endblock script %}

{% block stylesheet %}
    {{ block.super }}
{% endblock %}